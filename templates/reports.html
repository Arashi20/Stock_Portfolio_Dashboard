<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Reports</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Quill toolbar customization */
        .ql-toolbar.ql-snow {
            background: #6D8A6D !important;
            border-radius: 8px 8px 0 0 !important;
            /* Only top corners rounded */
            border-bottom-left-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            border-color: #b5a77a !important;
        }

        .ql-toolbar.ql-snow .ql-picker,
        .ql-toolbar.ql-snow button {
            color: #F8F5F0 !important;
            
            border: none;
        }

        .ql-toolbar.ql-snow .ql-picker-label,
        .ql-toolbar.ql-snow .ql-picker-options {
            color: #2C2C2C !important;
        }

        .ql-container.ql-snow {
            border-radius: 0 0 8px 8px !important;
            /* Only bottom corners rounded */
            background: #F8F5F0; 
            font-size: 1.08rem;
            color: #2C2C2C;  /* main text color */
            border-top-left-radius: 0 !important;
            border-top-right-radius: 0 !important;
        }

        /* Table styling for Old Money aesthetic */
        table {
            background: #F8F5F0;
            border-collapse: collapse;
            width: 100%;
        }

        thead {
            background: #1E3A34;
            color: #F8F5F0;
            font-family: 'Georgia', serif;
            font-variant: small-caps;
            font-weight: bold;
        }

        th,
        td {
            padding: 0.5rem;
        }

        tbody {
            color: #2C2C2C;
        }

        tr {
            border-bottom: 1px solid #D6C6B9;
        }

        a {
            text-decoration: underline;
        }

        .delete-link {
            color: #880D11;
        }

        .back-link {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: #6d8a6d;
            color: #fff;
            border-radius: 4px;
            text-align: center;
            text-decoration: none;
            transition: background 0.3s;
        }

        .back-link:hover {
            background: #5b7a5b;
        }
    </style>
</head>

<body>
    {% include 'sidebar.html' %}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
        {% for category, message in messages %}
        <li class="flash-{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
    <header>
        <h1>My Reports</h1>
        <p>“It is better to be roughly right than precisely wrong.” —John Maynard Keynes</p>
    </header>


    <section>
        <h2>Create New Report</h2>
        <form method="post" action="{{ url_for('reports_page') }}" class="report-form">
            <label><strong>Ticker:</strong>
                <input type="text" name="ticker" required class="beige-input"
                    value="{{ prefill.ticker if prefill else '' }}">
            </label><br>
            <label><strong>Title:</strong>
                <input type="text" name="title" required class="beige-input"
                    value="{% if prefill and prefill.ticker %}DCF Analysis for {{ prefill.ticker }}{% endif %}">
            </label><br>
            <strong>Notes/Analysis:</strong><br>
            <div id="prefill-content" style="display:none;">
                {% if prefill and prefill.ticker %}
                <p><strong>Intrinsic Value:</strong> ${{ prefill.intrinsic_value }}</p>
                <p><strong>FCF:</strong> {{ prefill.fcf }}</p>
                <p><strong>Growth Rate (1-5 yrs):</strong> {{ prefill.growth_1_5 }}%</p>
                <p><strong>Growth Rate (6-10 yrs):</strong> {{ prefill.growth_6_10 }}%</p>
                <p><strong>Discount Rate:</strong> {{ prefill.discount }}%</p>
                <p><strong>Terminal Growth Rate:</strong> {{ prefill.terminal_growth }}%</p>
                <p><strong>Shares Outstanding:</strong> {{ prefill.shares }}</p>
                {% endif %}
            </div>
            <div id="editor" style="background: #fff; border-radius: 8px; min-height: 200px;"></div>
            <input type="hidden" name="snippet" id="snippet">
            <br>
            <button type="submit"><strong>Save Report</strong></button>
        </form>
        <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
        <script>
            var quill = new Quill('#editor', {
                theme: 'snow'
            });

            // Prefill Quill editor if DCF data is present
            var prefillDiv = document.getElementById('prefill-content');
            if (prefillDiv && prefillDiv.innerHTML.trim().length > 0) {
                quill.root.innerHTML = prefillDiv.innerHTML;
            }

            // On form submit, copy HTML to hidden input
            document.querySelector('form').onsubmit = function () {
                document.getElementById('snippet').value = quill.root.innerHTML;
            };
        </script>

    </section>



    <section>
        <h2>Saved Reports</h2>
        <form method="get" action="{{ url_for('reports_page') }}" style="margin-bottom:1rem;">
            <input type="text" name="search" placeholder="Search by ticker..."
                value="{{ request.args.get('search', '') }}" class="beige-input" style="width:180px;">
            <button type="submit"
                style="background:#1E3A34; color:#fff; border:none; border-radius:4px; padding:4px 10px; cursor:pointer;">Search</button>
        </form>
        <table>
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr>
                    <td>{{ report.ticker }}</td>
                    <td>{{ report.title }}</td>
                    <td>{{ report.date }}</td>
                    <td>
                        <a href="{{ url_for('view_report', report_id=report.id) }}">View</a> |
                        <a href="{{ url_for('edit_report', report_id=report.id) }}">Edit</a> |
                        <a href="{{ url_for('delete_report', report_id=report.id) }}" class="delete-link"
                            data-report-title="{{ report.title }}">Delete</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <a href="{{ url_for('index') }}" class="back-link" style="
        display: inline-block;
        margin: 2rem auto;
        padding: 0.75rem 1.5rem;
        background: #1E3A34;
        color: #F8F5F0;
        text-align: center;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
        transition: background 0.3s, transform 0.3s;
    " onmouseover="this.style.background='#3b5d3a'; this.style.transform='scale(1.02)';"
        onmouseout="this.style.background='#1E3A34'; this.style.transform='scale(1)'">
        ← Back to Dashboard
    </a>



    <div id="deleteModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <h2>Confirm Deletion</h2>
            <p id="modalText">Are you sure you want to delete this report?</p>
            <button id="modalCancel" class="modal-btn cancel-btn">Cancel</button>
            <button id="modalConfirm" class="modal-btn confirm-btn">Delete</button>
        </div>
    </div>
    <script>
        // Auto-dismiss flash messages after 3 seconds and remove them from the DOM
        setTimeout(function () {
            document.querySelectorAll('.flashes li').forEach(function (el) {
                el.classList.add('hide');
            });
            setTimeout(function () {
                var flashes = document.querySelector('.flashes');
                if (flashes) {
                    flashes.remove();
                }
            }, 600); // Wait for fade-out transition to finish before removing
        }, 3000);
        // Custom Delete Modal Logic
        let deleteLinks = document.querySelectorAll('.delete-link');
        let modal = document.getElementById('deleteModal');
        let modalText = document.getElementById('modalText');
        let modalClose = document.getElementById('modalClose');
        let modalCancel = document.getElementById('modalCancel');
        let modalConfirm = document.getElementById('modalConfirm');
        let deleteUrl = '';

        deleteLinks.forEach(function (link) {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                deleteUrl = this.getAttribute('href');
                let title = this.getAttribute('data-report-title');
                modalText.textContent = `Are you sure you want to delete the report "${title}"?`;
                modal.style.display = 'flex';
            });
        });

        function closeModal() {
            modal.style.display = 'none';
            deleteUrl = '';
        }

        modalClose.onclick = closeModal;
        modalCancel.onclick = closeModal;

        modalConfirm.onclick = function () {
            if (deleteUrl) {
                window.location.href = deleteUrl;
            }
        };

        // Optional: Close modal when clicking outside modal-content
        window.onclick = function (event) {
            if (event.target == modal) {
                closeModal();
            }
        };
    </script>

</body>

</html>